<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Utilisasi Warehouse Yogya</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family:'Segoe UI',Tahoma,sans-serif; margin:0; background:#eef2f7; display:flex; transition:0.3s; }

    /* Sidebar */
    .sidebar {
      width:220px; background:#2c3e50; color:white; min-height:100vh;
      display:flex; flex-direction:column; padding:20px 10px;
      box-shadow:2px 0 6px rgba(0,0,0,0.2);
      position:relative; transition:transform 0.3s ease-in-out;
      z-index:1000;
    }
    .sidebar.collapsed { transform:translateX(-220px); }
    .sidebar h2 { font-size:16px; margin-bottom:15px; border-bottom:1px solid rgba(255,255,255,0.2); padding-bottom:8px; }
    .sidebar button {
      background:none; border:none; color:white; text-align:left; padding:10px 15px; border-radius:6px; cursor:pointer;
      font-size:14px; margin-bottom:6px; transition:0.3s;
    }
    .sidebar button:hover, .sidebar button.active { background:#34495e; }

    /* Main */
    .main { flex:1; display:flex; flex-direction:column; transition:margin-left 0.3s ease-in-out; }
    .main.shifted { margin-left:-220px; }

    header {
      display:flex; align-items:center; justify-content:flex-start;
      background:#ffffff; padding:12px 20px; color:#2c3e50; box-shadow:0 2px 5px rgba(0,0,0,0.1);
    }
    .menu-toggle {
      font-size:22px; cursor:pointer; margin-right:15px; border:none; background:none;
    }
    .logo { display:flex; align-items:center; margin-right:20px; flex-shrink:0; }
    .logo img { width:70px; height:40px; margin-right:10px; border-radius:8px; }
    .logo-text { display:flex; flex-direction:column; line-height:1.2; }
    .logo-text strong { font-size:14px; }
    .logo-text span { font-size:11px; opacity:0.7; }
    .controls { display:flex; gap:6px; align-items:center; flex-wrap:wrap; }
    button.ctrl { padding:6px 10px; border:none; border-radius:6px; cursor:pointer; font-size:12px; color:white; }
    .export{background:#27ae60;} .print{background:#2980b9;} .refresh{background:#f39c12;}
    .status { display:flex; align-items:center; font-size:11px; margin-left:6px; }
    .status span { width:8px; height:8px; border-radius:50%; display:inline-block; margin-right:4px; }
    .connected{background:#2ecc71;} .disconnected{background:#e74c3c;} .loading{background:#f1c40f;}

    .filters{margin:15px;display:flex;gap:8px;flex-wrap:wrap;}
    input[type=text]{padding:6px 8px;border:1px solid #ccc;border-radius:6px;flex:1; background:#f8f8f8;}
    select{padding:6px;border-radius:6px;background:#f8f8f8;}

    /* API Key Configuration */
    .config-section {
      margin: 15px;
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .config-section h4 {
      margin: 0 0 10px 0;
      color: #2c3e50;
    }
    .config-row {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-bottom: 10px;
    }
    .config-row input {
      flex: 1;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 6px;
    }
    .config-row button {
      padding: 8px 15px;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    .config-row button:hover {
      background: #2980b9;
    }
    .config-status {
      font-size: 12px;
      margin-top: 5px;
    }
    .config-status.success { color: #27ae60; }
    .config-status.error { color: #e74c3c; }

    /* Tabel */
    .table-container{margin:15px;background:white;padding:10px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.1);overflow-x:auto;}
    table{width:100%;border-collapse:collapse;font-size:13px;}
    th,td{border:1px solid #ddd;padding:6px;text-align:left;}
    th{background:#34495e;color:white;cursor:pointer;}
    th.sorted-asc::after{content:" ▲";} th.sorted-desc::after{content:" ▼";}
    tr:nth-child(even){background:#f9f9f9;}
    tr:hover { background:#dfe9f3; cursor:pointer; }
    tr.selected { background:#bbdefb !important; border-left: 4px solid #2196f3; }
    th:first-child { background:#34495e; color:white; }
    .totals{margin-top:8px;font-weight:bold;font-size:13px;text-align:right;color:#2c3e50;}

    /* Subtotal Styles */
    .subtotals {
      margin-top: 15px;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 6px;
      border: 1px solid #dee2e6;
    }
    .subtotals h4 {
      margin: 0 0 10px 0;
      color: #2c3e50;
      font-size: 14px;
    }
    .subtotal-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid #e9ecef;
      font-weight: bold;
      color: #495057;
    }
    .subtotal-row:last-child {
      border-bottom: none;
    }
    .subtotal-label {
      font-weight: 600;
    }
    .subtotal-value {
      color: #2c3e50;
      font-family: 'Courier New', monospace;
    }

    /* Conditional Formatting Styles */
    .negative-value {
      background-color: #ffebee !important;
      color: #c62828 !important;
      font-weight: bold;
    }

    /* Chart section */
    .charts { display:flex; flex-wrap:wrap; gap:20px; margin:15px; }
    .chart-card { background:white; border-radius:12px; padding:15px; flex:1; min-width:250px;
      box-shadow:0 2px 6px rgba(0,0,0,0.1); text-align:center; }
    .chart-card h4 { margin-bottom:10px; font-size:14px; color:#2c3e50; }
    canvas { max-height:180px !important; }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <h2>📑 Menu</h2>
    <button onclick="switchSheet(0)" class="active">Raw Material & Packaging</button>
    <button onclick="switchSheet(1)">Finish Goods</button>
  </div>

  <!-- Main Content -->
  <div class="main" id="main">
    <header>
      <button class="menu-toggle" onclick="toggleSidebar()">☰</button>
      <div class="logo">
        <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRYyanHkNjy-MEGWx-yRWA8XiFF9HbWiLoGFY9HRkEpuBXKYGjxU_TMW2dK4ONcqKA4tg&usqp=CAU">
        <div class="logo-text">
          <strong>Raw Material & Packaging</strong>
          <span>Update Stock Raw Material & Packaging</span>
        </div>
      </div>
      <div class="controls">
        <button class="ctrl export" onclick="exportTable()">⬇ Export</button>
        <button class="ctrl print" onclick="printTable()">🖨 Print</button>
        <button class="ctrl refresh" onclick="loadSheet()">🔄 Refresh Data</button>
        <div class="status" id="status">
          <span class="disconnected"></span><span id="statusText">Disconnected</span>
        </div>
      </div>
    </header>

    <!-- API Configuration Section -->
    <div class="config-section">
      <h4>🔑 Google Sheets API Configuration</h4>
      <div class="config-row">
        <input type="text" id="apiKey" placeholder="Enter your Google Sheets API Key" value="">
        <button onclick="saveApiKey()">Save API Key</button>
      </div>
      <div class="config-row">
        <input type="text" id="spreadsheetId1" placeholder="Spreadsheet ID for Raw Material & Packaging" value="">
        <input type="text" id="sheetName1" placeholder="Sheet Name (e.g., Sheet1)" value="Sheet1">
      </div>
      <div class="config-row">
        <input type="text" id="spreadsheetId2" placeholder="Spreadsheet ID for Finish Goods" value="">
        <input type="text" id="sheetName2" placeholder="Sheet Name (e.g., Sheet1)" value="Sheet1">
      </div>
      <div class="config-row">
        <input type="text" id="spreadsheetId3" placeholder="Spreadsheet ID for Capacity Data" value="">
        <input type="text" id="sheetName3" placeholder="Sheet Name (e.g., Sheet1)" value="Sheet1">
      </div>
      <div class="config-status" id="configStatus">Please configure your API key and spreadsheet IDs</div>
    </div>

    <!-- Mini Charts -->
    <div class="charts">
      <div class="chart-card">
        <h4>Kapasitas Gudang (%)</h4>
        <canvas id="capacityChart"></canvas>
      </div>
      <div class="chart-card">
        <h4>Stock and Empty Racking Report</h4>
        <canvas id="rackingChart"></canvas>
      </div>
    </div>

    <!-- Tabel kecil (Sheet 3) -->
    <div class="table-container">
      <h4>📊 Data Kapasitas Gudang</h4>
      <table id="miniTable"><thead></thead><tbody></tbody></table>
    </div>

    <!-- Tabel utama -->
    <div class="filters">
      <input type="text" id="searchBox" placeholder="🔍 Search..." oninput="applyFilters()">
      <select id="filterC" onchange="applyFilters()"><option value="">-- Filter --</option></select>
    </div>
    <div class="table-container">
      <table id="sheetTable"><thead></thead><tbody></tbody></table>
      <!-- Subtotals Section -->
      <div class="subtotals" id="subtotals" style="display: none;">
        <h4>📊 Sub Totals</h4>
        <!-- Sheet 1 Subtotals -->
        <div class="subtotal-row" id="subtotalRowH">
          <span class="subtotal-label">Sub Total Pcs:</span>
          <span class="subtotal-value" id="subtotalH">0</span>
        </div>
        <div class="subtotal-row" id="subtotalRowI">
          <span class="subtotal-label">Sub Total Kgs/Roll/Meter/Ltr:</span>
          <span class="subtotal-value" id="subtotalI">0</span>
        </div>
        <!-- Sheet 2 Subtotals -->
        <div class="subtotal-row" id="subtotalRowL">
          <span class="subtotal-label">Sub Total Saldo Akhir:</span>
          <span class="subtotal-value" id="subtotalL">0</span>
        </div>
        <div class="subtotal-row" id="subtotalRowP">
          <span class="subtotal-label">Sub Total Saldo Akhir Kgs:</span>
          <span class="subtotal-value" id="subtotalP">0</span>
        </div>
        <div class="subtotal-row" id="subtotalRowM">
          <span class="subtotal-label">Sub Total Keluar:</span>
          <span class="subtotal-value" id="subtotalM">0</span>
        </div>
        <div class="subtotal-row" id="subtotalRowQ">
          <span class="subtotal-label">Sub Total Keluar Kgs:</span>
          <span class="subtotal-value" id="subtotalQ">0</span>
        </div>
      </div>
    </div>
  </div>

<script>
// Google Sheets API Configuration
let apiKey = '';
let spreadsheetConfigs = [
  { id: '', sheetName: 'Sheet1' }, // Raw Material & Packaging
  { id: '', sheetName: 'Sheet1' }, // Finish Goods
  { id: '', sheetName: 'Sheet1' }  // Capacity Data
];

const sheetTitles = [
  { title: "Raw Material & Packaging", subtitle: "Update Stock Raw Material & Packaging" },
  { title: "Finish Goods", subtitle: "Update Stock Barang Jadi" }
];

let activeSheet = 0;
let allRows = [];
let miniRows = [];
let currentSort = { index: -1, asc: true };
let capacityChart, rackingChart;

// Load saved configuration from localStorage alternative (using variables)
let savedConfig = {
  apiKey: '',
  spreadsheetId1: '',
  sheetName1: 'Sheet1',
  spreadsheetId2: '',
  sheetName2: 'Sheet1',
  spreadsheetId3: '',
  sheetName3: 'Sheet1'
};

// Initialize configuration
function initializeConfig() {
  document.getElementById('apiKey').value = savedConfig.apiKey;
  document.getElementById('spreadsheetId1').value = savedConfig.spreadsheetId1;
  document.getElementById('sheetName1').value = savedConfig.sheetName1;
  document.getElementById('spreadsheetId2').value = savedConfig.spreadsheetId2;
  document.getElementById('sheetName2').value = savedConfig.sheetName2;
  document.getElementById('spreadsheetId3').value = savedConfig.spreadsheetId3;
  document.getElementById('sheetName3').value = savedConfig.sheetName3;
  
  // Update internal configuration
  apiKey = savedConfig.apiKey;
  spreadsheetConfigs[0] = { id: savedConfig.spreadsheetId1, sheetName: savedConfig.sheetName1 };
  spreadsheetConfigs[1] = { id: savedConfig.spreadsheetId2, sheetName: savedConfig.sheetName2 };
  spreadsheetConfigs[2] = { id: savedConfig.spreadsheetId3, sheetName: savedConfig.sheetName3 };
}

// Save API configuration
function saveApiKey() {
  const apiKeyInput = document.getElementById('apiKey').value.trim();
  const spreadsheetId1 = document.getElementById('spreadsheetId1').value.trim();
  const sheetName1 = document.getElementById('sheetName1').value.trim() || 'Sheet1';
  const spreadsheetId2 = document.getElementById('spreadsheetId2').value.trim();
  const sheetName2 = document.getElementById('sheetName2').value.trim() || 'Sheet1';
  const spreadsheetId3 = document.getElementById('spreadsheetId3').value.trim();
  const sheetName3 = document.getElementById('sheetName3').value.trim() || 'Sheet1';
  
  if (!apiKeyInput) {
    updateConfigStatus('Please enter a valid API key', 'error');
    return;
  }
  
  if (!spreadsheetId1 || !spreadsheetId2 || !spreadsheetId3) {
    updateConfigStatus('Please enter all spreadsheet IDs', 'error');
    return;
  }
  
  // Save to memory
  savedConfig = {
    apiKey: apiKeyInput,
    spreadsheetId1: spreadsheetId1,
    sheetName1: sheetName1,
    spreadsheetId2: spreadsheetId2,
    sheetName2: sheetName2,
    spreadsheetId3: spreadsheetId3,
    sheetName3: sheetName3
  };
  
  // Update internal configuration
  apiKey = apiKeyInput;
  spreadsheetConfigs[0] = { id: spreadsheetId1, sheetName: sheetName1 };
  spreadsheetConfigs[1] = { id: spreadsheetId2, sheetName: sheetName2 };
  spreadsheetConfigs[2] = { id: spreadsheetId3, sheetName: sheetName3 };
  
  updateConfigStatus('Configuration saved successfully! You can now load data.', 'success');
  
  // Auto-load data after configuration
  setTimeout(loadSheet, 500);
}

// Update configuration status
function updateConfigStatus(message, type) {
  const statusElement = document.getElementById('configStatus');
  statusElement.textContent = message;
  statusElement.className = `config-status ${type}`;
}

// Google Sheets API function to fetch data
async function fetchSheetData(spreadsheetId, sheetName) {
  if (!apiKey || !spreadsheetId) {
    throw new Error('API key or spreadsheet ID not configured');
  }
  
  const range = `${sheetName}!A:Z`; // Adjust range as needed
  const url = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${range}?key=${apiKey}`;
  
  const response = await fetch(url);
  
  if (!response.ok) {
    const errorData = await response.json();
    throw new Error(`Google Sheets API Error: ${errorData.error?.message || response.statusText}`);
  }
  
  const data = await response.json();
  return data.values || [];
}

// Function to calculate subtotals for both sheets
function calculateSubtotals(rows) {
  if (rows.length <= 1) return { 
    subtotalH: 0, subtotalI: 0, subtotalL: 0, subtotalP: 0, subtotalM: 0, subtotalQ: 0 
  };
  
  let subtotalH = 0, subtotalI = 0, subtotalL = 0, subtotalP = 0, subtotalM = 0, subtotalQ = 0;
  
  // Skip header row and calculate totals
  rows.slice(1).forEach(row => {
    // Sheet 1 columns: H (index 7) and I (index 8)
    if (activeSheet === 0) {
      const valueH = parseFloat(row[7]) || 0;
      if (!isNaN(valueH)) subtotalH += valueH;
      
      const valueI = parseFloat(row[8]) || 0;
      if (!isNaN(valueI)) subtotalI += valueI;
    }
    
    // Sheet 2 columns: L (index 11), P (index 15), M (index 12), Q (index 16)
    if (activeSheet === 1) {
      const valueL = parseFloat(row[11]) || 0;
      if (!isNaN(valueL)) subtotalL += valueL;
      
      const valueP = parseFloat(row[15]) || 0;
      if (!isNaN(valueP)) subtotalP += valueP;
      
      const valueM = parseFloat(row[12]) || 0;
      if (!isNaN(valueM)) subtotalM += valueM;
      
      const valueQ = parseFloat(row[16]) || 0;
      if (!isNaN(valueQ)) subtotalQ += valueQ;
    }
  });
  
  return { subtotalH, subtotalI, subtotalL, subtotalP, subtotalM, subtotalQ };
}

// Function to update subtotals display
function updateSubtotals(rows) {
  const subtotals = calculateSubtotals(rows);
  const subtotalSection = document.getElementById('subtotals');
  
  // Get all subtotal elements
  const subtotalH = document.getElementById('subtotalH');
  const subtotalI = document.getElementById('subtotalI');
  const subtotalL = document.getElementById('subtotalL');
  const subtotalP = document.getElementById('subtotalP');
  const subtotalM = document.getElementById('subtotalM');
  const subtotalQ = document.getElementById('subtotalQ');
  
  // Get subtotal row elements for show/hide
  const subtotalRowH = document.getElementById('subtotalRowH');
  const subtotalRowI = document.getElementById('subtotalRowI');
  const subtotalRowL = document.getElementById('subtotalRowL');
  const subtotalRowP = document.getElementById('subtotalRowP');
  const subtotalRowM = document.getElementById('subtotalRowM');
  const subtotalRowQ = document.getElementById('subtotalRowQ');
  
  if (rows.length > 1) {
    // Sheet 1 (Raw Material & Packaging) - Show H and I subtotals
    if (activeSheet === 0) {
      subtotalH.textContent = subtotals.subtotalH.toLocaleString('id-ID', {
        minimumFractionDigits: 0,
        maximumFractionDigits: 2
      });
      subtotalI.textContent = subtotals.subtotalI.toLocaleString('id-ID', {
        minimumFractionDigits: 0,
        maximumFractionDigits: 2
      });
      
      // Show Sheet 1 subtotals, hide Sheet 2 subtotals
      subtotalRowH.style.display = 'flex';
      subtotalRowI.style.display = 'flex';
      subtotalRowL.style.display = 'none';
      subtotalRowP.style.display = 'none';
      subtotalRowM.style.display = 'none';
      subtotalRowQ.style.display = 'none';
      
      subtotalSection.style.display = 'block';
    }
    // Sheet 2 (Finish Goods) - Show L, P, M, Q subtotals
    else if (activeSheet === 1) {
      subtotalL.textContent = subtotals.subtotalL.toLocaleString('id-ID', {
        minimumFractionDigits: 0,
        maximumFractionDigits: 2
      });
      subtotalP.textContent = subtotals.subtotalP.toLocaleString('id-ID', {
        minimumFractionDigits: 0,
        maximumFractionDigits: 2
      });
      subtotalM.textContent = subtotals.subtotalM.toLocaleString('id-ID', {
        minimumFractionDigits: 0,
        maximumFractionDigits: 2
      });
      subtotalQ.textContent = subtotals.subtotalQ.toLocaleString('id-ID', {
        minimumFractionDigits: 0,
        maximumFractionDigits: 2
      });
      
      // Show Sheet 2 subtotals, hide Sheet 1 subtotals
      subtotalRowH.style.display = 'none';
      subtotalRowI.style.display = 'none';
      subtotalRowL.style.display = 'flex';
      subtotalRowP.style.display = 'flex';
      subtotalRowM.style.display = 'flex';
      subtotalRowQ.style.display = 'flex';
      
      subtotalSection.style.display = 'block';
    }
  } else {
    subtotalSection.style.display = 'none';
  }
}

// Function to check if value should be formatted
function shouldApplyConditionalFormatting(value, columnIndex, headers) {
  // Only apply to Sheet 2 (Finish Goods) - activeSheet === 1
  if (activeSheet !== 1) return null;
  
  // Skip hidden columns
  if (shouldHideColumn(columnIndex)) return null;
  
  // Check if column contains numeric data that could be stock/quantity
  const header = headers[columnIndex]?.toLowerCase() || '';
  const isNumericColumn = header.includes('stock') || 
                          header.includes('qty') || 
                          header.includes('quantity') || 
                          header.includes('balance') || 
                          header.includes('amount') ||
                          header.includes('jumlah') ||
                          header.includes('saldo') ||
                          header.includes('stok');
  
  // If it's not clearly a numeric column by header name, check if the value is numeric
  if (!isNumericColumn) {
    const testValue = parseFloat(value);
    if (isNaN(testValue)) return null;
  }
  
  const numValue = parseFloat(value);
  if (isNaN(numValue)) return null;
  
  // Only apply formatting for negative values
  if (numValue < 0) return 'negative-value';
  return null;
}

function toggleSidebar(){
  const sidebar=document.getElementById("sidebar");
  if(window.innerWidth<=768){
    sidebar.classList.toggle("show");
  }else{
    sidebar.classList.toggle("collapsed");
    document.getElementById("main").classList.toggle("shifted");
  }
}

function switchSheet(index){
  activeSheet=index;
  document.querySelectorAll(".sidebar button").forEach((btn,i)=>btn.classList.toggle("active",i===index));
  document.querySelector(".logo-text strong").textContent = sheetTitles[index].title;
  document.querySelector(".logo-text span").textContent = sheetTitles[index].subtitle;
  loadSheet();
}

async function loadSheet(){
  if (!apiKey) {
    updateConfigStatus('Please configure API key and spreadsheet IDs first', 'error');
    setStatus("disconnected", "Configuration required");
    return;
  }
  
  setStatus("loading","Loading...");
  try{
    // Load main sheet
    const mainSheetData = await fetchSheetData(
      spreadsheetConfigs[activeSheet].id, 
      spreadsheetConfigs[activeSheet].sheetName
    );
    allRows = mainSheetData;
    renderTable(allRows);
    fillFilter(allRows);
    updateCharts(allRows);
    updateSubtotals(allRows);

    // Load capacity sheet (always sheet 3)
    const capacitySheetData = await fetchSheetData(
      spreadsheetConfigs[2].id, 
      spreadsheetConfigs[2].sheetName
    );
    miniRows = capacitySheetData;
    renderMiniTable(miniRows);

    setStatus("connected","Connected");
    updateConfigStatus('Data loaded successfully', 'success');
  } catch(error) {
    console.error('Error loading sheet:', error);
    setStatus("disconnected","Error: " + error.message);
    updateConfigStatus('Error loading data: ' + error.message, 'error');
  }
}

// Function to check if column should be hidden
function shouldHideColumn(columnIndex) {
  // Hide columns C (index 2) and D (index 3) only on Sheet 2 (Finish Goods)
  return activeSheet === 1 && (columnIndex === 2 || columnIndex === 3);
}

// Updated renderTable function with conditional formatting and column hiding
function renderTable(rows){
  let thead=document.querySelector("#sheetTable thead");
  let tbody=document.querySelector("#sheetTable tbody");
  thead.innerHTML=""; tbody.innerHTML="";
  
  if(rows.length === 0) return;
  
  let header=document.createElement("tr");
  rows[0].forEach((h,i)=>{
    // Skip hidden columns
    if(shouldHideColumn(i)) return;
    
    let th=document.createElement("th"); th.textContent=h;
    th.onclick=()=>sortTable(i);
    if(currentSort.index===i) th.classList.add(currentSort.asc?"sorted-asc":"sorted-desc");
    header.appendChild(th);
  }); thead.appendChild(header);

  rows.slice(1).forEach(r=>{
    let tr=document.createElement("tr");
    r.forEach((c,i)=>{
      // Skip hidden columns
      if(shouldHideColumn(i)) return;
      
      let td=document.createElement("td"); 
      td.textContent=c;
      
      // Apply conditional formatting
      const formatClass = shouldApplyConditionalFormatting(c, i, rows[0]);
      if(formatClass) {
        td.classList.add(formatClass);
      }
      
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
  
  // Update subtotals after rendering table
  updateSubtotals(rows);
}

function renderMiniTable(rows){
  let thead=document.querySelector("#miniTable thead");
  let tbody=document.querySelector("#miniTable tbody");
  thead.innerHTML=""; tbody.innerHTML="";
  if(rows.length === 0) return;
  
  let header=document.createElement("tr");
  rows[0].forEach(h=>{ let th=document.createElement("th"); th.textContent=h; header.appendChild(th); });
  thead.appendChild(header);

  rows.slice(1).forEach((r,i)=>{
    let tr=document.createElement("tr");
    r.forEach(c=>{ let td=document.createElement("td"); td.textContent=c; tr.appendChild(td); });
    tr.onclick=()=>{
      // Remove active class from all rows
      document.querySelectorAll("#miniTable tbody tr").forEach(row => row.classList.remove("selected"));
      // Add active class to clicked row
      tr.classList.add("selected");
      
      // Update capacity chart with single row data
      updateCharts([rows[0],r]); 
      // Update racking chart with selected row data
      updateRackingChart(r);
    };
    tbody.appendChild(tr);
  });
}

function updateCharts(rows){
  if(rows.length < 2) return;
  let headers = rows[0];
  let locIdx = headers.indexOf("Warehouse Location");
  let stockedIdx = headers.indexOf("Stocked Racking Percent");
  let emptyIdx = headers.indexOf("Empty Racking Percent");
  if(locIdx<0||stockedIdx<0||emptyIdx<0) return;

  let labels = [];
  let stocked = [];
  let empty = [];
  rows.slice(1).forEach(r=>{
    labels.push(r[locIdx]);
    stocked.push(parseFloat(r[stockedIdx]||0));
    empty.push(parseFloat(r[emptyIdx]||0));
  });

  if(capacityChart) capacityChart.destroy();
  capacityChart = new Chart(document.getElementById("capacityChart"), {
    type:"bar",
    data:{ labels, datasets:[
      { label:"Stocked %", data:stocked, backgroundColor:"#3498db" },
      { label:"Empty %", data:empty, backgroundColor:"#95a5a6" }
    ]},
    options:{ responsive:true, plugins:{legend:{position:"bottom"}}, scales:{x:{stacked:true},y:{stacked:true,max:100}} }
  });

  // Update Racking Chart to use data from Sheet 3 (miniRows) columns C and D
  updateRackingChart();
}

// New function to update Racking Chart using Sheet 3 data
function updateRackingChart(selectedRow = null){
  if(miniRows.length < 2) return;
  
  let stockedData = [];
  let emptyData = [];
  
  if(selectedRow) {
    // Use data from selected row only
    let stockedVal = parseFloat(selectedRow[2]||0); // Column C - Stocked values
    let emptyVal = parseFloat(selectedRow[3]||0);   // Column D - Empty values
    stockedData.push(stockedVal);
    emptyData.push(emptyVal);
  } else {
    // Use data from all rows (default behavior)
    miniRows.slice(1).forEach(r=>{
      let stockedVal = parseFloat(r[2]||0); // Column C - Stocked values
      let emptyVal = parseFloat(r[3]||0);   // Column D - Empty values
      stockedData.push(stockedVal);
      emptyData.push(emptyVal);
    });
  }

  // Calculate total values
  let totalStocked = stockedData.reduce((a,b)=>a+b,0);
  let totalEmpty = emptyData.reduce((a,b)=>a+b,0);
  
  if(rackingChart) rackingChart.destroy();
  rackingChart = new Chart(document.getElementById("rackingChart"), {
    type:"doughnut",
    data:{ 
      labels:["Stocked","Empty"], 
      datasets:[{ 
        data:[totalStocked,totalEmpty], 
        backgroundColor:["#27ae60","#e74c3c"] 
      }] 
    },
    options:{ 
      responsive:true, 
      plugins:{
        legend:{position:"bottom"},
        tooltip: {
          callbacks: {
            label: function(context) {
              let total = totalStocked + totalEmpty;
              let percentage = total > 0 ? ((context.parsed / total) * 100).toFixed(1) : 0;
              return context.label + ': ' + context.parsed.toLocaleString() + ' (' + percentage + '%)';
            }
          }
        }
      }
    }
  });
}

function sortTable(i){
  // Skip sorting if column is hidden
  if(shouldHideColumn(i)) return;
  
  let rows=[...allRows]; if(i===currentSort.index) currentSort.asc=!currentSort.asc; else currentSort={index:i,asc:true};
  let header=rows.shift();
  rows.sort((a,b)=>{
    let va=a[i],vb=b[i]; let na=parseFloat(va), nb=parseFloat(vb);
    if(!isNaN(na)&&!isNaN(nb)) return currentSort.asc?na-nb:nb-na;
    return currentSort.asc?va.localeCompare(vb):vb.localeCompare(va);
  });
  let sortedRows = [header,...rows];
  renderTable(sortedRows);
  updateSubtotals(sortedRows); // Update subtotals after sorting
}

function applyFilters(){
  let search=document.getElementById("searchBox").value.toLowerCase();
  let fC=document.getElementById("filterC").value;
  let filtered=allRows.filter((r,i)=>{
    if(i===0)return true;
    let s=r.some(c=>c.toLowerCase().includes(search));
    let mC=!fC||r[1]===fC;
    return s && mC;
  });
  renderTable(filtered);
  updateCharts(filtered);
  updateSubtotals(filtered); // Update subtotals after filtering
}

function fillFilter(rows){
  let sc=document.getElementById("filterC");
  sc.innerHTML="<option value=''>-- Filter --</option>";
  let vals=[...new Set(rows.slice(1).map(r=>r[1]))];
  vals.forEach(v=>{if(v){let o=document.createElement("option");o.value=v;o.textContent=v;sc.appendChild(o);}});
}

function exportTable(){ 
  // Create filtered data without hidden columns for export
  let exportData = allRows.map(row => {
    return row.filter((_, index) => !shouldHideColumn(index));
  });
  
  let csv=Papa.unparse(exportData); 
  let blob=new Blob([csv],{type:"text/csv"}); 
  let url=URL.createObjectURL(blob); 
  let a=document.createElement("a"); 
  a.href=url; 
  a.download="warehouse_data.csv"; 
  a.click(); 
  URL.revokeObjectURL(url);
}

function printTable(){ 
  window.print(); 
}

function setStatus(st,t){ 
  let span=document.querySelector("#status span"); 
  span.className=st==="connected"?"connected":st==="loading"?"loading":"disconnected"; 
  document.getElementById("statusText").textContent=t; 
}

// Initialize the application
initializeConfig();

// Auto-load if configuration is already set
if (savedConfig.apiKey && savedConfig.spreadsheetId1) {
  loadSheet();
}
</script>
</body>
</html>
